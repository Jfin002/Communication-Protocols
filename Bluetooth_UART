Main.c

#include "stm32f4xx.h"

/* -------------------- DEFINES -------------------- */
#define LED_PIN     (1U << 13)   // PD13
#define GPIODEN     (1U << 3)
#define GPIOAEN     (1U << 0)

#define USART2EN    (1U << 17)

/* -------------------- FUNCTION PROTOTYPES -------------------- */
void gpio_led_init(void);
void usart2_init(void);
char usart2_read(void);

/* -------------------- MAIN -------------------- */
int main(void)
{
    gpio_led_init();
    usart2_init();

    char rx;

    while (1)
    {
        rx = usart2_read();   // Read data from HC-05

        if (rx == '1')        // Send '1' from phone
        {
            GPIOD->ODR |= LED_PIN;   // LED ON
        }
        else if (rx == '0')   // Send '0' from phone
        {
            GPIOD->ODR &= ~LED_PIN;  // LED OFF
        }
    }
}

/* -------------------- GPIO INIT (LED) -------------------- */
void gpio_led_init(void)
{
    // Enable GPIOD clock
    RCC->AHB1ENR |= GPIODEN;

    // Set PD13 as output (01)
    GPIOD->MODER &= ~(1U << 27);
    GPIOD->MODER |=  (1U << 26);
}

/* -------------------- USART2 INIT -------------------- */
void usart2_init(void)
{
    // Enable GPIOA clock
    RCC->AHB1ENR |= GPIOAEN;

    // Enable USART2 clock
    RCC->APB1ENR |= USART2EN;

    // Set PA2, PA3 to Alternate Function mode
    GPIOA->MODER &= ~((1U << 4) | (1U << 6));
    GPIOA->MODER |=  (1U << 5) | (1U << 7);

    // Select AF7 (USART2) for PA2 and PA3
    GPIOA->AFR[0] |= (7U << 8);   // PA2
    GPIOA->AFR[0] |= (7U << 12);  // PA3

    // Baud rate = 9600 @ 16 MHz
    USART2->BRR = 0x0683;

    // Enable USART, TX, RX
    USART2->CR1 |= (1U << 13); // UE
    USART2->CR1 |= (1U << 3);  // TE
    USART2->CR1 |= (1U << 2);  // RE
}

/* -------------------- USART READ -------------------- */
char usart2_read(void)
{
    while (!(USART2->SR & (1U << 5))); // Wait for RXNE
    return USART2->DR;
}
